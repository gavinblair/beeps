<html>
    <head>
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    </head><body>
<h1>Teachable Machine Audio Model J</h1>
<div id="label-container"></div>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

<script type="text/javascript">

document.addEventListener('visibilitychange', function () {
    if (!document.hidden) {
        location.reload();
    }
});


    // more documentation available at
    // https://github.com/tensorflow/tfjs-models/tree/master/speech-commands

    // the link to your model provided by Teachable Machine export panel
    const URL = "https://gavinblair.github.io/beeps/Beeps/";
    
    let recognizer;


    async function createModel() {
        const checkpointURL = URL + "model.json"; // model topology
        const metadataURL = URL + "metadata.json"; // model metadata

        recognizer = speechCommands.create(
            "BROWSER_FFT", // fourier transform type, not useful to change
            undefined, // speech commands vocabulary feature, not useful for your models
            checkpointURL,
            metadataURL);

        // check that model and metadata are loaded via HTTPS requests.
        await recognizer.ensureModelLoaded();

        return recognizer;
    }

    async function init() {
        recognizer = await createModel();
        const classLabels = recognizer.wordLabels(); // get class labels
        const labelContainer = document.getElementById("label-container");
        for (let i = 0; i < classLabels.length; i++) {
            labelContainer.appendChild(document.createElement("div"));
        }
        recognizer.listen(result => {
            const scores = result.scores;
            const threshold = 0.98;

            for (let i = 0; i < classLabels.length; i++) {
                const classPrediction = classLabels[i] + ": " + result.scores[i].toFixed(2);
                labelContainer.childNodes[i].innerHTML = classPrediction;
                if (scores[i] >= threshold && classLabels[i] != "Background Noise") {
                    //https://maker.ifttt.com/use/qoU6fXUzdeBHXla_ZNG0_

                    const event = 'beep';
                    const key = 'qoU6fXUzdeBHXla_ZNG0_';
                    triggerIFTTT(event, key);
                   
                }
            }
        }, {
            includeSpectrogram: true,
            probabilityThreshold: 0.98,
            invokeCallbackOnNoiseAndUnknown: true,
            overlapFactor: 0.50
        });
    }
    
async function triggerIFTTT(event, key) {
    const iftttURL = `https://maker.ifttt.com/trigger/\${event}/with/key/\${key}`;
    try {
        const response = await fetch(iftttURL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        });
        if (response.ok) {
            alert("ifttt success");
            console.log('IFTTT triggered successfully');
        } else {
            alert("ifttt error");
            console.error('Error triggering IFTTT:', response.statusText);
        }
    } catch (error) {
        alert("ifttt ERROR");
        console.error('Error triggering IFTTT:', error);
    }
}

setTimeout(function(){init();},500);
    </script></body></html>
